class ConnectionService{#refToken="";#authToken="";#jwtToken="";#endpoint="https://api.donatty.com";#authService;constructor(e,t){this.#endpoint=this.#fmtApiUri(t),this.#authToken=e,this.#refToken=t,this.#authService=new AuthService(this.authEndpoint)}get authEndpoint(){return this.#endpoint+"/auth/tokens"}get widgetsEndpoint(){return this.#endpoint+("/widgets/"+this.#refToken)}get sseEndpoint(){return this.widgetsEndpoint+"/sse"}get#zoneOffset(){return(new Date).getTimezoneOffset()}#fmtApiUri=e=>{var t=e.length,e=e.slice(t-2,t),t=1+parseInt(e,16)%29,e=new Intl.NumberFormat("en-IN",{minimumIntegerDigits:3}).format(t);return"https://api.donatty.com".replace("://api.",`://api-${e}.`)};async#getJWT(){return this.#jwtToken||(this.#jwtToken=await this.#authService.auth(this.#authToken)),this.#jwtToken}async getSSEConnection(){var e=await this.#getJWT();return new EventSource(this.sseEndpoint+`?jwt=${e}&zoneOffset=`+this.#zoneOffset)}async getData(){try{var e=await this.#getJWT(),{props:{data:{goal:t,goalCollected:n}}}=(await(await fetch(this.widgetsEndpoint,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e}})).json()).response;return{goal:t,raised:n}}catch(e){throw console.error("Failed to fetch initial data:",e),e}}}class AuthService{#endpoint="";constructor(e){this.#endpoint=e}async auth(e){let t="";try{var{accessToken:n}=(await(await fetch(this.#endpoint+"/"+e,{method:"GET",headers:{"Content-Type":"application/json"}})).json()).response;t=n}catch(e){console.error("Failed to fetch JWT token:",e)}return t}}class SSEService{#RECONNECT_INTERVAL=6e5;#MESSAGE_TYPES={DATA:"DATA",PING:"PING",REFRESH:"REFRESH",DELETE:"DELETE"};#ref;#connectionService;#reconnectionTimeout=null;#eventSource=null;constructor(e,t){this.#connectionService=t,this.#ref=e}async#connectToSSE(){this.#eventSource&&this.#eventSource.close();var e=await this.#connectionService.getSSEConnection();e.onmessage=e=>{this.handleMessage(e.data)},e.onerror=e=>{console.error("SSE error",e),console.error("reconnecting..."),this.#eventSource.close(),this.#clearReconnectTimeout(),setTimeout(()=>this.#connectToSSE(),5e3)},this.#eventSource=e,this.#scheduleReconnect()}#scheduleReconnect(){this.#clearReconnectTimeout(),this.#reconnectionTimeout=setTimeout(()=>{console.info("Reconnecting SSE after 10 minutes..."),this.#connectToSSE()},this.#RECONNECT_INTERVAL)}#clearReconnectTimeout(){this.#reconnectionTimeout&&(clearTimeout(this.#reconnectionTimeout),this.#reconnectionTimeout=null)}#prepareMessage(e){var{action:e,data:t}=JSON.parse(e);let n,i,a;switch(e){case this.#MESSAGE_TYPES.REFRESH:n=this.#MESSAGE_TYPES.DATA,a=t.props.data.goalCollected,i=t.props.data.goal;break;case this.#MESSAGE_TYPES.DATA:n=this.#MESSAGE_TYPES.DATA,a=t.raised;break;default:n=this.#MESSAGE_TYPES.PING}return{type:n,goal:i,raised:a}}handleMessage(e){document.dispatchEvent(new CustomEvent(this.#ref+"_sse_message",{detail:{message:e}}));var{type:e,goal:t,raised:n}=this.#prepareMessage(e);e===this.#MESSAGE_TYPES.DATA&&document.dispatchEvent(new CustomEvent(this.#ref+"_sse_data",{detail:{raised:n,goal:t}}))}async start(){return this.#connectToSSE()}}class DataService{#ref="";#token="";#sseService;#connectionService;goal=0;raised=0;get percent(){return this.raised/this.goal||0}constructor({token:e,ref:t}){this.#token=e,this.#ref=t,this.#connectionService=new ConnectionService(e,t),this.#sseService=new SSEService(t,this.#connectionService),document.addEventListener(t+"_sse_data",({detail:e})=>this.handleData(e)),this.#init()}async#init(){var{goal:e,raised:t}=await this.#connectionService.getData();this.goal=e,this.raised=t,this.#sseService.start()}handleData({raised:e,goal:t}){this.raised=e,null!=t&&(this.goal=t),document.dispatchEvent(new CustomEvent(this.#ref+"_data",{detail:{raised:e,goal:t,percent:this.percent}}))}}class DataController{#dataService;#dataServiceReverse;get percent(){let e=this.#dataService.percent;var t;return this.#dataServiceReverse&&(t=this.#dataServiceReverse.percent,e-=t),e}constructor(e,t){document.addEventListener(e.ref+"_data",()=>this.#update(e.ref)),this.#dataService=new DataService(e),t&&(document.addEventListener(t.ref+"_data",()=>this.#update(t.ref)),this.#dataServiceReverse=new DataService(t))}#update(){var e={percent:this.percent,goal:{goal:this.#dataService.goal,raised:this.#dataService.raised,percent:this.#dataService.percent}};this.#dataServiceReverse&&(e.goalReverse={goal:this.#dataServiceReverse.goal,raised:this.#dataServiceReverse.raised,percent:this.#dataServiceReverse.percent}),document.dispatchEvent(new CustomEvent("goal_updated",{detail:e}))}}export default DataController;